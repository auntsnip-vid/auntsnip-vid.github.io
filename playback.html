<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Feed</title>

<style>
html,body{
  margin:0;
  height:100%;
  background:#000;
}

.feed{
  height:100%;
  overflow-y:scroll;
  scroll-snap-type:y mandatory;
}

.item{
  height:100%;
  position:relative;
  scroll-snap-align:start;
}

video{
  width:100%;
  height:100%;
  object-fit:cover;
}

.user{
  position:absolute;
  bottom:20px;
  left:12px;
  color:#fff;
}
</style>
</head>

<body>

<!-- SAFE BANNER (boleh langsung tampil) -->
<div style="position:fixed;bottom:10px;left:50%;transform:translateX(-50%);z-index:999;">
<script>
window.atOptions={key:'e3390cf0a8cdf953ded85bdaaf3046a5',format:'iframe',height:250,width:300};
</script>
<script src="https://situateddivine.com/e3390cf0a8cdf953ded85bdaaf3046a5/invoke.js"></script>
</div>

<div class="feed" id="feed"></div>

<script>
/* ========= DATA ========= */
const list = JSON.parse(localStorage.getItem("VIDEO_LIST")) || [];
if(!list.length) location.href="index.html";

const feed = document.getElementById("feed");

/* ========= RENDER ========= */
list.forEach(v=>{
  const d=document.createElement("div");
  d.className="item";
  d.dataset.id=v.id;
  d.innerHTML=`
    <video src="${v.src}" muted loop playsinline></video>
    <div class="user">${v.user}</div>
  `;
  feed.appendChild(d);
});

/* ========= SWIPE TRACK ========= */
let swipe=0;
let adStep=0;
let lastId=null;

const observer=new IntersectionObserver(entries=>{
  entries.forEach(e=>{
    const vid=e.target.querySelector("video");
    if(e.isIntersecting){
      vid.play();

      if(lastId!==e.target.dataset.id){
        swipe++;
        lastId=e.target.dataset.id;

        if(swipe%4===0){
          triggerAd();
        }
      }
    }else{
      vid.pause();
    }
  });
},{threshold:0.7});

document.querySelectorAll(".item").forEach(i=>observer.observe(i));

/* ========= AD ROTATION ========= */
function triggerAd(){
  if(adStep===0) showInterstitial();
  if(adStep===1) loadSocialBar();
  if(adStep===2) loadPopunder();
  adStep=(adStep+1)%3;
}

/* ========= ADS ========= */
function showInterstitial(){
  if(document.getElementById("inter"))return;
  const d=document.createElement("div");
  d.id="inter";
  d.style="position:fixed;inset:0;background:#000c;z-index:99999;display:flex;justify-content:center;align-items:center";
  d.innerHTML=`<div onclick="this.parentNode.remove()" style="color:#fff;position:absolute;top:20px;right:20px">âœ•</div>`;
  document.body.appendChild(d);

  window.atOptions={key:'e3390cf0a8cdf953ded85bdaaf3046a5',format:'iframe',height:250,width:300};
  const s=document.createElement("script");
  s.src="https://situateddivine.com/e3390cf0a8cdf953ded85bdaaf3046a5/invoke.js";
  d.appendChild(s);
}

function loadSocialBar(){
  if(window.sb)return;
  window.sb=1;
  const s=document.createElement("script");
  s.src="https://situateddivine.com/1a/f2/a7/1af2a727f2e2997184c468f92e0a6145.js";
  document.body.appendChild(s);
}

function loadPopunder(){
  if(window.pop)return;
  window.pop=1;
  const s=document.createElement("script");
  s.src="https://situateddivine.com/b8/1f/13/b81f134cc26510fc67813f6dca90178f.js";
  document.body.appendChild(s);
}
</script>

</body>
</html>
