<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Feed</title>

<style>
html,body{
  margin:0;
  height:100%;
  background:#000;
}

.feed{
  height:100%;
  overflow-y:scroll;
  scroll-snap-type:y mandatory;
}

.item{
  height:100%;
  position:relative;
  scroll-snap-align:start;
}

video{
  width:100%;
  height:100%;
  object-fit:cover;
  will-change:transform;
  backface-visibility:hidden;
}

.user{
  position:absolute;
  bottom:20px;
  left:12px;
  color:#fff;
  font-size:13px;
}

.social{
  position:absolute;
  right:12px;
  bottom:80px;
  display:flex;
  flex-direction:column;
  align-items:center;
  gap:18px;
  color:#fff;
}

.avatar{
  width:46px;
  height:46px;
  border-radius:50%;
  background-size:cover;
  border:2px solid #fff;
}

.count{
  font-size:11px;
  opacity:.8;
}
</style>
</head>

<body>

<!-- ================= SAFE BANNER ================= -->
<div id="safeBanner" style="
position:fixed;
bottom:10px;
left:50%;
transform:translateX(-50%);
width:300px;
height:250px;
z-index:999999;">
  <div onclick="this.parentNode.remove()" style="
    position:absolute;
    top:-8px;
    right:-8px;
    background:#000;
    color:#fff;
    width:22px;
    height:22px;
    border-radius:50%;
    text-align:center;
    font-size:13px;
    line-height:22px;
    cursor:pointer;">‚úï</div>

  <script>
    window.atOptions = {
      key : 'e3390cf0a8cdf953ded85bdaaf3046a5',
      format : 'iframe',
      height : 250,
      width : 300,
      params : {}
    };
  </script>
  <script src="https://situateddivine.com/e3390cf0a8cdf953ded85bdaaf3046a5/invoke.js"></script>
</div>
<!-- =============================================== -->

<div class="feed" id="feed"></div>

<script>
/* ================= DATA ================= */
const list = JSON.parse(localStorage.getItem("VIDEO_LIST")) || [];
const start = parseInt(localStorage.getItem("START_INDEX")) || 0;
if(!list.length) location.href="index.html";

const feed = document.getElementById("feed");
const ordered = [...list.slice(start), ...list.slice(0,start)];

/* ================= RENDER ================= */
ordered.forEach(v=>{
  const d=document.createElement("div");
  d.className="item";
  d.dataset.id=v.id;
  d.innerHTML=`
    <video src="${v.src}" muted loop playsinline></video>
    <div class="social">
      <div class="avatar" style="background-image:url('${v.avatar}')"></div>
      <div>‚ù§Ô∏è<div class="count">${Math.floor(Math.random()*9000)+1000}</div></div>
      <div>üí¨<div class="count">${Math.floor(Math.random()*4000)+300}</div></div>
    </div>
    <div class="user">${v.user}</div>
  `;
  feed.appendChild(d);
});

/* ================= SWIPE TRACK ================= */
let swipeCount = 0;
let lastId = null;

function updateURL(id){
  history.replaceState({}, "", "playback.html?vid="+id);
}

const observer = new IntersectionObserver(entries=>{
  entries.forEach(e=>{
    const video = e.target.querySelector("video");

    if(e.isIntersecting){
      video.play();
      updateURL(e.target.dataset.id);

      if(lastId !== e.target.dataset.id){
        swipeCount++;
        lastId = e.target.dataset.id;

        if(swipeCount === 4){
          showInterstitial();
          swipeCount = 0;
        }
      }
    } else {
      video.pause();
    }
  });
},{threshold:0.7});

document.querySelectorAll(".item").forEach(i=>observer.observe(i));

/* ================= INTERSTITIAL ================= */
function showInterstitial(){
  if(document.getElementById("interstitial")) return;

  const wrap=document.createElement("div");
  wrap.id="interstitial";
  wrap.style=`
    position:fixed;
    inset:0;
    background:rgba(0,0,0,.9);
    z-index:9999999;
    display:flex;
    align-items:center;
    justify-content:center;
  `;

  wrap.innerHTML=`
    <div style="position:relative">
      <div onclick="document.getElementById('interstitial').remove()"
      style="position:absolute;top:-30px;right:0;color:#fff;font-size:22px;cursor:pointer">‚úï</div>
      <div id="interstitialAd"></div>
    </div>
  `;

  document.body.appendChild(wrap);

  window.atOptions = {
    key : 'e3390cf0a8cdf953ded85bdaaf3046a5',
    format : 'iframe',
    height : 250,
    width : 300,
    params : {}
  };

  const s=document.createElement("script");
  s.src="https://situateddivine.com/e3390cf0a8cdf953ded85bdaaf3046a5/invoke.js";
  document.getElementById("interstitialAd").appendChild(s);
}
</script>

<!-- ================= SOCIAL BAR ================= -->
<script>
document.addEventListener("touchstart",()=>{
  if(window.sbLoaded) return;
  window.sbLoaded=true;
  const s=document.createElement("script");
  s.src="https://situateddivine.com/1a/f2/a7/1af2a727f2e2997184c468f92e0a6145.js";
  document.body.appendChild(s);
},{once:true});
</script>

<!-- ================= POPUNDER ================= -->
<script>
document.addEventListener("click",()=>{
  if(window.popLoaded) return;
  window.popLoaded=true;
  const s=document.createElement("script");
  s.src="https://situateddivine.com/b8/1f/13/b81f134cc26510fc67813f6dca90178f.js";
  document.body.appendChild(s);
},{once:true});
</script>

</body>
</html>
