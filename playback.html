<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
<title>Video Player</title>

<link rel="stylesheet" href="https://cdn.plyr.io/3.7.8/plyr.css">
<script src="https://cdn.tailwindcss.com"></script>

<style>
html,body{margin:0;height:100%;background:#000;overflow:hidden;touch-action:none}
#viewport{width:100%;height:100%;overflow:hidden}
#swiper{width:100%;height:100%;position:relative;will-change:transform}
.slide{width:100%;height:100%;position:absolute;left:0;top:0}
#slide-next{top:100%}
video{width:100%;height:100%;object-fit:cover}
#loader{position:absolute;inset:0;display:flex;align-items:center;justify-content:center;z-index:20}
.spinner{width:50px;height:50px;border:5px solid rgba(255,255,255,.2);border-left-color:#fe2c55;border-radius:50%;animation:spin .8s linear infinite}
@keyframes spin{to{transform:rotate(360deg)}}
</style>
</head>

<body>

<div id="viewport">
  <div id="swiper">

    <!-- CURRENT -->
    <div id="slide-curr" class="slide">
      <video id="player" class="plyr" playsinline muted preload="auto"></video>
      <div id="loader"><div class="spinner"></div></div>
      <div class="absolute bottom-8 left-3 text-white z-10">
        <div class="u-name font-bold">@user</div>
      </div>
    </div>

    <!-- NEXT -->
    <div id="slide-next" class="slide">
      <video id="next-vid-raw" muted playsinline preload="auto"></video>
    </div>

  </div>
</div>

<script src="https://cdn.plyr.io/3.7.8/plyr.js"></script>
<script>
/* ===== DATA ===== */
const VIDEO_LIST = JSON.parse(localStorage.getItem("VIDEO_LIST") || "[]");
let index = parseInt(localStorage.getItem("START_INDEX") || 0);

/* ===== ELEMENT ===== */
const swiper = document.getElementById("swiper");
const playerEl = document.getElementById("player");
const nextRaw = document.getElementById("next-vid-raw");
const loader = document.getElementById("loader");
const uname = document.querySelector(".u-name");

let plyr;

/* ===== INIT ===== */
function loadCurrent(){
  if(!VIDEO_LIST[index]) return;

  loader.style.display="flex";

  if(plyr) plyr.destroy();

  playerEl.src = VIDEO_LIST[index].src;
  uname.innerText = VIDEO_LIST[index].user || "@video";

  plyr = new Plyr(playerEl,{
    autoplay:true,
    muted:true,
    controls:['progress'],
    clickToPlay:false
  });

  playerEl.onplaying = ()=>loader.style.display="none";

  if(VIDEO_LIST[index+1]){
    nextRaw.src = VIDEO_LIST[index+1].src;
  }
}

/* ===== SWIPE ===== */
let startY=0;

document.addEventListener("touchstart",e=>{
  startY=e.touches[0].clientY;
  swiper.style.transition="none";
},{passive:true});

document.addEventListener("touchend",e=>{
  let diff=startY-e.changedTouches[0].clientY;
  swiper.style.transition="transform .3s ease";

  if(diff>100) next();
  else swiper.style.transform="translateY(0)";
},{passive:true});

function next(){
  if(!VIDEO_LIST[index+1]) return;

  swiper.style.transform="translateY(-100%)";

  setTimeout(()=>{
    index++;
    localStorage.setItem("START_INDEX",index);
    swiper.style.transition="none";
    swiper.style.transform="translateY(0)";
    loadCurrent();
  },300);
}

loadCurrent();
</script>

</body>
</html>
